version: '3.8'

services:
  # Traefik - Reverse Proxy com HTTPS automático# NFC Management Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nfc_app
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgresql://${DB_USER:-nfc_user}:${DB_PASSWORD}@postgres:5432/${DB_NAME:-nfc_management}
      
      # Manus OAuth
      VITE_APP_ID: ${VITE_APP_ID}
      OAUTH_SERVER_URL: ${OAUTH_SERVER_URL}
      VITE_OAUTH_PORTAL_URL: ${VITE_OAUTH_PORTAL_URL}
      
      # JWT e Segurança
      JWT_SECRET: ${JWT_SECRET}
      
      # Owner Info
      OWNER_NAME: ${OWNER_NAME}
      OWNER_OPEN_ID: ${OWNER_OPEN_ID}
      
      # Manus APIs
      BUILT_IN_FORGE_API_URL: ${BUILT_IN_FORGE_API_URL}
      BUILT_IN_FORGE_API_KEY: ${BUILT_IN_FORGE_API_KEY}
      VITE_FRONTEND_FORGE_API_URL: ${VITE_FRONTEND_FORGE_API_URL}
      VITE_FRONTEND_FORGE_API_KEY: ${VITE_FRONTEND_FORGE_API_KEY}
      
      # Analytics (opcional)
      VITE_ANALYTICS_ENDPOINT: ${VITE_ANALYTICS_ENDPOINT:-}
      VITE_ANALYTICS_WEBSITE_ID: ${VITE_ANALYTICS_WEBSITE_ID:-}
      
      # App Config
      VITE_APP_TITLE: ${VITE_APP_TITLE:-Sistema de Gerenciamento de Gravações NFC}
      VITE_APP_LOGO: ${VITE_APP_LOGO:-/logo.png}
    
    volumes:
      - ./data:/app/data
    networks:
      - nfc_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.app.entrypoints=http,https"
      - "traefik.http.routers.app.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.app.service=app"
      - "traefik.http.services.app.loadbalancer.server.port=3000"
      - "traefik.http.routers.app.middlewares=https-redirect"
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
      - "traefik.http.routers.app-secure.entrypoints=https"
      - "traefik.http.routers.app-secure.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.app-secure.service=app"
      - "traefik.http.routers.app-secure.tls=true"
      - "traefik.http.routers.app-secure.tls.certresolver=letsencrypt"
      - "traefik.http.middlewares.app-headers.headers.accesscontrolalloworiginlist=${DOMAIN}"
      - "traefik.http.middlewares.app-headers.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.app-headers.headers.addvaryheader=true"



networks:
  nfc_network:
    driver: bridge
