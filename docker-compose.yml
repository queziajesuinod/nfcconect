version: "3.9"

services:
  nfcconecta:
    image: nfc_conect:latest
    environment:
      NODE_ENV: production
      PORT: 3008
      DATABASE_URL: postgresql://root:kZ7oYab65fQITbyPPV6CLgrL5NIONpwZ@62.72.63.137:5432/iecg_bd
      
      # Manus OAuth
      VITE_APP_ID: ${VITE_APP_ID}
      OAUTH_SERVER_URL: ${OAUTH_SERVER_URL}
      VITE_OAUTH_PORTAL_URL: ${VITE_OAUTH_PORTAL_URL}
      
      # JWT e Seguran√ßa
      JWT_SECRET: ${JWT_SECRET}
      
      # Owner Info
      OWNER_NAME: ${OWNER_NAME}
      OWNER_OPEN_ID: ${OWNER_OPEN_ID}
      
      # Manus APIs
      BUILT_IN_FORGE_API_URL: ${BUILT_IN_FORGE_API_URL}
      BUILT_IN_FORGE_API_KEY: ${BUILT_IN_FORGE_API_KEY}
      VITE_FRONTEND_FORGE_API_URL: ${VITE_FRONTEND_FORGE_API_URL}
      VITE_FRONTEND_FORGE_API_KEY: ${VITE_FRONTEND_FORGE_API_KEY}
      
      # Analytics (opcional)
      VITE_ANALYTICS_ENDPOINT: ${VITE_ANALYTICS_ENDPOINT:-}
      VITE_ANALYTICS_WEBSITE_ID: ${VITE_ANALYTICS_WEBSITE_ID:-}
      
      # App Config
      VITE_APP_TITLE: ${VITE_APP_TITLE:-Sistema de Gerenciamento de Grava√ß√µes NFC}
      VITE_APP_LOGO: ${VITE_APP_LOGO:-/logo.png}
      REGISTRATION_SECRET: "excelencia"
      VITE_REGISTRATION_SECRET: "excelencia"
      
    networks:
      - network_public

    deploy:
      mode: replicated
      replicas: 1
      restart_policy:
        condition: on-failure
        max_attempts: 3

      placement:
        constraints:
          - node.role == manager
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=network_public"
      
        # üîπ API backend: https://conecta.iecg.com.br
        - "traefik.http.routers.nfcconecta.rule=Host(`conecta.iecg.com.br`)"
        - "traefik.http.routers.nfcconecta.entrypoints=websecure"
      
        # habilita TLS e usa o resolver CERTO
        - "traefik.http.routers.nfcconecta.tls=true"
        - "traefik.http.routers.nfcconecta.tls.certresolver=letsencryptresolver"
      
        # service l√≥gico visto pelo Traefik
        - "traefik.http.routers.nfcconecta.service=nfcconecta"
        - "traefik.http.services.nfcconecta.loadbalancer.server.port=3008"


networks:
  network_public:
    external: true
